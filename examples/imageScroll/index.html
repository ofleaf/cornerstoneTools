<!DOCTYPE html>
<html>
  <head>
    <title>Cornerstone Image Scroll</title>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1" />
    <meta charset="utf-8" />
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="./cornerstone.min.css" rel="stylesheet"/>
    <link href="./styles/style.css" rel="stylesheet"/>
  </head>
  <body>
    <div class="container">
      <input type="file" id="files" multiple />
      <div id="image-viewer" class="image-viewer">
        <div class="image-canvas" ondblclick="showUpLayout(event);">
          <div id="mrbottomright" style="position: absolute; bottom: 6px; right: 3px;"></div>
        </div>
        <div class="image-canvas" ondblclick="showUpLayout(event);">
          <div id="mrbottomright" style="position: absolute; bottom: 6px; right: 3px;"></div>
        </div>
        <div class="image-canvas" ondblclick="showUpLayout(event);">
          <div id="mrbottomright" style="position: absolute; bottom: 6px; right: 3px;"></div>
        </div>
        <div class="image-canvas" ondblclick="showUpLayout(event);">
          <div id="mrbottomright" style="position: absolute; bottom: 6px; right: 3px;"></div>
        </div>
      </div>
    </div>
    <script src="https://unpkg.com/cornerstone-core/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math/dist/cornerstoneMath.min.js"></script>
    <script src="./dist/cornerstoneTools.js"></script>
    <script src="./dist/dicomParser.min.js"></script>
    <script src="./dist/cornerstoneWADOImageLoader.js"></script>
    <script>window.cornerstoneTools || document.write('<script src="https://unpkg.com/cornerstone-tools">\x3C/script>')</script>
  </body>
  <script>
  cornerstoneWADOImageLoader.external.cornerstone = cornerstone;

  var config = {
    webWorkerPath : './dist/cornerstoneWADOImageLoaderWebWorker.js',
    taskConfiguration: {
      'decodeTask' : {
        codecsPath: './cornerstoneWADOImageLoaderCodecs.js'
      }
    }
  };
  cornerstoneWADOImageLoader.webWorkerManager.initialize(config);
  
  const layout = 4;
  let stacks = []

  /*
     for (let i = 0; i < layout; i++) {
     const imageCanvas = document.createElement('div');
     imageCanvas.classList.add('image-canvas');
     imageCanvas.setAttribute('ondblclick', 'showUpLayout()');
     document.getElementById('image-viewer').appendChild(imageCanvas);
     }
   */


  const elements = document.getElementsByClassName('image-canvas');
  for (let i = 0; i < elements.length; i++) {
    let stack = {
      element: elements[i],
      stack: {
        currentImageIdIndex: i,
        imageIds: null
      }
    }
    stacks.push(stack)
    cornerstone.enable(elements[i]);
  }

  const inputFiles = document.getElementById('files');
  inputFiles.addEventListener('change', function (e) {
    const files = e.target.files;
    let imageIds = [];

    for (let i = 0; i < files.length; i++) {
      imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));
    }
    createStacks(imageIds);
    loadAndViewImage(imageIds);
  });

  // let sync = new cornerstoneTools.Synchronizer('cornerstonenewimage', cornerstoneTools.stackImageIndexSynchronizer);
  /*
     let sync = new cornerstoneTools.Synchronizer('cornerstonenewimage', (e) => {
     console.log(e)
     })
   */
  // let sync = new cornerstoneTools.Synchronizer('cornerstonenewimage', cornerstoneTools.stackImagePositionOffsetSynchronizer);
  let sync = new cornerstoneTools.ImageSynchronizer('cornerstonenewimage', cornerstoneTools.stackSeriesImage);
  
  function loadAndViewImage (imageIds) {
    for (let s = 0; s < stacks.length; s++) {
      /*
      for (let i = 0; i < imageIds.length; i++) {
        cornerstone.loadImage(imageIds[i]).then(image => {
          cornerstone.displayImage(stacks[s].element, image);
        });
      }
      */
      cornerstone.loadImage(imageIds[0]).then(image => {
        cornerstone.displayImage(stacks[s].element, image);
      });
      stacks[s].element.addEventListener('cornerstonenewimage', onNewImage)
      cornerstoneTools.mouseInput.enable(stacks[s].element)
      cornerstoneTools.mouseWheelInput.enable(stacks[s].element)
      cornerstoneTools.addStackStateManager(stacks[s].element, ['stack'])
      cornerstoneTools.addToolState(stacks[s].element, 'stack', stacks[s].stack)
      cornerstoneTools.stackScrollWheel.activate(stacks[s].element)
      sync.add(stacks[s].element)
      // sync.getDistances();
    }
  }

  function onNewImage (e) {
    let eventData = e.detail;
    let newImageIdIndex;
    let result = stacks.find(v => v.element === eventData.element);
    let slice = result.element.querySelector('#mrbottomright');
    slice.textContent = `Image ${ result.stack.currentImageIdIndex + 1} \/ ${ result.stack.imageIds.length }`;
  }
  
  function createStacks (imageIds) {
    for (let i = 0; i < stacks.length; i++) {
      stacks[i].stack.imageIds = imageIds;
    }
  }

  function showUpLayout (e) {
    const canvas = e.target;
    const index = Array.prototype.indexOf.call(canvas, e.target);
    const result = Array.prototype.map.call(canvas, (cur, index, arr) => {
      if (cur === e.target) {
        cur.setAttribute('style', 'visibility: visible; width: 100%; height: 100%;');
      } else {
        cur.setAttribute('style', 'visibility: hidden;');
      }
    })
  }
  </script>
</html>
